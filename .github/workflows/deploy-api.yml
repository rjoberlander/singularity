name: Deploy API to Digital Ocean

on:
  push:
    branches:
      - master
    paths:
      - 'apps/api/**'
      - '.github/workflows/deploy-api.yml'
  workflow_dispatch:  # Allow manual trigger

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Deploy to Digital Ocean Droplet
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.DO_WEB_HOST }}
          username: deploy
          key: ${{ secrets.DO_SSH_PRIVATE_KEY }}
          command_timeout: 20m
          script: |
            cd /var/www/singularity
            # Ensure swap exists to prevent OOM during npm install
            if [ ! -f /swapfile ]; then
              echo "Creating 2GB swap file..."
              sudo fallocate -l 2G /swapfile
              sudo chmod 600 /swapfile
              sudo mkswap /swapfile
              sudo swapon /swapfile
            fi
            sudo chown -R deploy:deploy .git
            git fetch origin master
            git reset --hard origin/master
            echo "Deployed commit: $(git rev-parse HEAD)"
            echo "Admin routes file exists: $(test -f apps/api/src/routes/admin.ts && echo 'yes' || echo 'no')"
            # Don't delete node_modules - let npm handle incremental updates to avoid OOM
            sudo rm -rf apps/api/dist
            # Limit Node memory during install to prevent OOM
            NODE_OPTIONS="--max-old-space-size=512" npm install --prefer-offline
            cd apps/api
            npm run build
            echo "Checking dist/routes/admin.js exists:"
            ls -la dist/routes/admin.js 2>/dev/null || echo "ERROR: admin.js not found in dist!"
            echo "Checking admin import in dist/index.js:"
            grep -c "admin" dist/index.js || echo "ERROR: no admin references in dist/index.js!"
            sudo mkdir -p /var/log/pm2
            sudo chown -R deploy:deploy /var/log/pm2
            # Show all PM2 processes and node processes
            echo "All PM2 processes:"
            pm2 list
            echo "All Node.js processes:"
            ps aux | grep node | grep -v grep || echo "No node processes"
            echo "Process on port 3001:"
            sudo lsof -i :3001 2>/dev/null || echo "No lsof output"
            # Stop ALL PM2 apps
            pm2 kill
            # Kill any node process running on port 3001
            sudo fuser -k 3001/tcp 2>/dev/null || true
            sleep 3
            echo "After killing, port 3001:"
            sudo lsof -i :3001 2>/dev/null || echo "Port 3001 is now free"
            # Clear Node.js require cache by removing all cached modules
            rm -rf /home/deploy/.pm2/logs/singularity-api* 2>/dev/null || true
            # Start fresh - both API and web
            pm2 start /var/www/singularity/apps/api/ecosystem.config.js --update-env
            pm2 start /var/www/singularity/apps/web/ecosystem.config.js --update-env 2>/dev/null || echo "Web ecosystem not found or already running"
            sleep 5
            echo "PM2 processes after restart:"
            pm2 list
            echo "Checking port 3001 after start:"
            lsof -i :3001 2>/dev/null || ss -tlnp 'sport = :3001' 2>/dev/null || echo "No process found"
            echo "API test response:"
            curl -s http://localhost:3001/api/v1 | head -c 500 || echo "API not responding"
            pm2 save
            # Update nginx to proxy /api to Express backend
            bash /var/www/singularity/apps/api/deploy/update-nginx.sh
            echo "API deployed at $(date)"
